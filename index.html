<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Spotify Player Web - Login e Controles</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #121212; color: white; max-width: 500px; margin: auto; }
  button {
    font-size: 16px;
    padding: 10px 20px;
    margin: 5px 5px 5px 0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #1DB954;
    color: white;
  }
  button:disabled {
    background-color: #555;
    cursor: not-allowed;
  }
  #status {
    margin-top: 20px;
    white-space: pre-line;
  }
</style>
</head>
<body>

<h1>Spotify Player Web</h1>

<button id="loginBtn">Login no Spotify</button>

<div id="controls" style="display:none; margin-top: 20px;">
  <button id="btnPrev">⏮️ Anterior</button>
  <button id="btnPlay">▶️ Play</button>
  <button id="btnPause">⏸️ Pause</button>
  <button id="btnNext">⏭️ Próxima</button>
</div>

<div id="status">Aguardando login...</div>

<script>
  const clientId = 'c3011e20ed7a4a7398f551b2bab6fa66';
  const redirectUri = window.location.origin + window.location.pathname;
  const scopes = [
    'streaming',
    'user-read-email',
    'user-read-private',
    'user-modify-playback-state',
    'user-read-playback-state'
  ];

  // --- PKCE helpers ---
  function generateRandomString(length) {
    let text = '';
    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    for (let i = 0; i < length; i++) {
      text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
  }

  async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return new Uint8Array(hash);
  }

  function base64UrlEncode(buffer) {
    let base64 = btoa(String.fromCharCode.apply(null, [...buffer]));
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  async function generateCodeChallenge(codeVerifier) {
    const hashed = await sha256(codeVerifier);
    return base64UrlEncode(hashed);
  }

  // --- OAuth login ---
  async function login() {
    const codeVerifier = generateRandomString(128);
    const codeChallenge = await generateCodeChallenge(codeVerifier);
    sessionStorage.setItem('code_verifier', codeVerifier);

    const state = generateRandomString(16);
    const scope = scopes.join(' ');

    const args = new URLSearchParams({
      response_type: 'code',
      client_id: clientId,
      scope: scope,
      redirect_uri: redirectUri,
      state: state,
      code_challenge_method: 'S256',
      code_challenge: codeChallenge
    });

    window.location = 'https://accounts.spotify.com/authorize?' + args;
  }

  // --- Troca código por token ---
  async function fetchAccessToken(code) {
    const codeVerifier = sessionStorage.getItem('code_verifier');
    const body = new URLSearchParams({
      client_id: clientId,
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: redirectUri,
      code_verifier: codeVerifier
    });

    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: body.toString()
    });

    if (!response.ok) throw new Error('Erro ao pegar token');

    return response.json();
  }

  // --- Cria player e retorna player e device_id ---
  function createPlayer(token) {
    return new Promise((resolve, reject) => {
      window.onSpotifyWebPlaybackSDKReady = () => {
        const player = new Spotify.Player({
          name: 'Web Playback SDK Demo',
          getOAuthToken: cb => { cb(token); }
        });

        player.addListener('ready', ({ device_id }) => {
          updateStatus('Player pronto. Device ID: ' + device_id);
          resolve({ player, device_id });
        });

        player.addListener('not_ready', ({ device_id }) => {
          updateStatus('Device não está pronto: ' + device_id);
        });

        player.addListener('initialization_error', ({ message }) => {
          reject(new Error('Erro na inicialização: ' + message));
        });

        player.addListener('authentication_error', ({ message }) => {
          reject(new Error('Erro de autenticação: ' + message));
        });

        player.addListener('player_state_changed', state => {
          if (!state) return;
          const { paused, position, duration, track_window } = state;
          updateStatus(
            `Tocando: ${track_window.current_track.name} — ${track_window.current_track.artists.map(a => a.name).join(', ')}\n` +
            `Estado: ${paused ? 'Pausado' : 'Tocando'}\n` +
            `Posição: ${(position/1000).toFixed(1)}s / ${(duration/1000).toFixed(1)}s`
          );
        });

        player.connect();
      };

      const script = document.createElement('script');
      script.src = 'https://sdk.scdn.co/spotify-player.js';
      document.body.appendChild(script);
    });
  }

  // --- Função pra tocar música na device ---
  async function playTrack(device_id, token, uri) {
    const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ uris: [uri] })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error('Erro ao tocar música: ' + (errorData.error.message || response.status));
    }
  }

  // --- Controle de playback ---
  async function pauseTrack(token) {
    await fetch('https://api.spotify.com/v1/me/player/pause', {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
  }

  async function resumeTrack(token) {
    await fetch('https://api.spotify.com/v1/me/player/play', {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
  }

  async function nextTrack(token) {
    await fetch('https://api.spotify.com/v1/me/player/next', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
  }

  async function previousTrack(token) {
    await fetch('https://api.spotify.com/v1/me/player/previous', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
  }

  // --- Atualiza status texto ---
  function updateStatus(text) {
    document.getElementById('status').innerText = text;
  }

  // --- Variáveis globais ---
  let accessToken = null;
  let deviceId = null;

  // --- Eventos dos botões ---
  document.getElementById('loginBtn').onclick = () => login();

  document.getElementById('btnPlay').onclick = () => {
    if (!accessToken) return;
    resumeTrack(accessToken);
  };

  document.getElementById('btnPause').onclick = () => {
    if (!accessToken) return;
    pauseTrack(accessToken);
  };

  document.getElementById('btnNext').onclick = () => {
    if (!accessToken) return;
    nextTrack(accessToken);
  };

  document.getElementById('btnPrev').onclick = () => {
    if (!accessToken) return;
    previousTrack(accessToken);
  };

  // --- Fluxo principal ao abrir a página ---
  async function main() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (!code) return;

    document.getElementById('loginBtn').style.display = 'none';
    updateStatus('Trocando código por token...');

    try {
      const tokenData = await fetchAccessToken(code);

      // Limpa URL para não ficar código exposto
      window.history.replaceState({}, document.title, redirectUri);

      accessToken = tokenData.access_token;

      updateStatus('Token obtido! Inicializando player...');

      const { player, device_id } = await createPlayer(accessToken);
      deviceId = device_id;

      document.getElementById('controls').style.display = 'block';

      // Toca uma música exemplo (Mr. Brightside - The Killers)
      await playTrack(deviceId, accessToken, 'spotify:track:3n3Ppam7vgaVa1iaRUc9Lp');

    } catch (e) {
      updateStatus('Erro: ' + e.message);
      document.getElementById('loginBtn').style.display = 'block';
    }
  }

  main();
</script>

</body>
  </html>

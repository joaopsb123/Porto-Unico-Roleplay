<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Spotify Playback SDK + Login</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  button { font-size: 16px; padding: 10px 20px; margin-top: 10px; }
  #status { margin-top: 20px; }
</style>
</head>
<body>

<h1>Spotify Player Web - Login e Playback</h1>

<button id="loginBtn">Login no Spotify</button>
<div id="status"></div>

<script>
  // Configurações do app
  const clientId = 'c3011e20ed7a4a7398f551b2bab6fa66';
  const redirectUri = window.location.origin + window.location.pathname; // mesmo arquivo
  const scopes = [
    'streaming',
    'user-read-email',
    'user-read-private',
    'user-modify-playback-state',
    'user-read-playback-state'
  ];

  // PKCE helper functions
  function generateRandomString(length) {
    let text = '';
    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    for (let i = 0; i < length; i++) {
      text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
  }

  async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return new Uint8Array(hash);
  }

  function base64UrlEncode(buffer) {
    let base64 = btoa(String.fromCharCode.apply(null, [...buffer]));
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  async function generateCodeChallenge(codeVerifier) {
    const hashed = await sha256(codeVerifier);
    return base64UrlEncode(hashed);
  }

  // Login com PKCE
  async function login() {
    const codeVerifier = generateRandomString(128);
    const codeChallenge = await generateCodeChallenge(codeVerifier);
    sessionStorage.setItem('code_verifier', codeVerifier);

    const state = generateRandomString(16);
    const scope = scopes.join(' ');

    const args = new URLSearchParams({
      response_type: 'code',
      client_id: clientId,
      scope: scope,
      redirect_uri: redirectUri,
      state: state,
      code_challenge_method: 'S256',
      code_challenge: codeChallenge
    });

    window.location = 'https://accounts.spotify.com/authorize?' + args;
  }

  // Troca código por token
  async function fetchAccessToken(code) {
    const codeVerifier = sessionStorage.getItem('code_verifier');
    const body = new URLSearchParams({
      client_id: clientId,
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: redirectUri,
      code_verifier: codeVerifier
    });

    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: body.toString()
    });

    if (!response.ok) throw new Error('Erro ao pegar token');

    return response.json();
  }

  // Inicializa player
  function createPlayer(token) {
    return new Promise((resolve, reject) => {
      window.onSpotifyWebPlaybackSDKReady = () => {
        const player = new Spotify.Player({
          name: 'Web Playback SDK Demo',
          getOAuthToken: cb => { cb(token); }
        });

        player.addListener('ready', ({ device_id }) => {
          document.getElementById('status').innerText = 'Player pronto. Device ID: ' + device_id;
          resolve({ player, device_id });
        });

        player.addListener('not_ready', ({ device_id }) => {
          document.getElementById('status').innerText = 'Device não está pronto: ' + device_id;
        });

        player.addListener('initialization_error', ({ message }) => {
          reject(new Error('Erro na inicialização: ' + message));
        });

        player.addListener('authentication_error', ({ message }) => {
          reject(new Error('Erro de autenticação: ' + message));
        });

        player.connect();
      };

      // Carrega SDK
      const script = document.createElement('script');
      script.src = 'https://sdk.scdn.co/spotify-player.js';
      document.body.appendChild(script);
    });
  }

  // Começa a tocar música no device
  async function playTrack(device_id, token, uri) {
    const response = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${device_id}`, {
      method: 'PUT',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ uris: [uri] })
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error('Erro ao tocar música: ' + (errorData.error.message || response.status));
    }
  }

  // Lógica principal

  document.getElementById('loginBtn').onclick = async () => {
    login();
  };

  async function main() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (!code) return;

    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('status').innerText = 'Trocando código por token...';

    try {
      const tokenData = await fetchAccessToken(code);

      // Limpa URL
      window.history.replaceState({}, document.title, redirectUri);

      const { access_token, refresh_token, expires_in } = tokenData;

      document.getElementById('status').innerText = 'Token obtido! Inicializando player...';

      const { player, device_id } = await createPlayer(access_token);

      // Exemplo: tocar uma música famosa
      const spotifyUri = 'spotify:track:3n3Ppam7vgaVa1iaRUc9Lp'; // “Mr. Brightside” - The Killers

      await playTrack(device_id, access_token, spotifyUri);

      document.getElementById('status').innerText += '\n Tocando Mr. Brightside do The Killers!';

    } catch (e) {
      document.getElementById('status').innerText = 'Erro: ' + e.message;
      document.getElementById('loginBtn').style.display = 'block';
    }
  }

  main();

</script>

</body>
</html>
